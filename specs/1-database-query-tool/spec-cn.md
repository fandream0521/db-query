# 功能规范：数据库查询工具

**功能 ID：** 1-database-query-tool  
**状态：** 草案  
**创建日期：** 2025-12-14  
**最后更新：** 2025-12-14

## 概述

此功能使用户能够连接到数据库，探索数据库架构（表和视图），并通过直接 SQL 输入和自然语言界面执行查询。系统存储数据库连接信息和架构元数据以供重用，使用户能够高效查询数据库，无需重复设置连接。

## 用户场景与测试

### 主要用户流程

1. 用户通过界面提供数据库连接 URL
2. 系统建立与数据库的连接
3. 系统检索并显示数据库中可用的表和视图
4. 用户可以：
   - 在查询编辑器中直接输入 SQL 查询
   - 提供所需查询的自然语言描述
5. 系统验证并执行查询
6. 结果以表格格式显示

### 替代流程

**自然语言查询流程：**
1. 用户选择数据库连接
2. 用户输入自然语言查询请求（例如："显示客户表中的所有用户"）
3. 系统基于可用的架构信息生成 SQL 查询
4. 用户可以查看生成的 SQL（可选）
5. 系统执行查询并显示结果

**重用现有连接：**
1. 用户选择之前保存的数据库连接
2. 系统加载存储的架构元数据
3. 用户无需重新连接即可继续执行查询

### 边界情况

- 提供了无效的数据库连接 URL
- 数据库连接失败（网络问题、身份验证错误）
- 数据库不包含表或视图
- SQL 查询包含语法错误
- SQL 查询尝试非 SELECT 操作（INSERT、UPDATE、DELETE 等）
- 查询返回无结果
- 查询返回极大的结果集
- 自然语言查询无法理解或转换为 SQL
- 初始连接后数据库架构发生变化

## 功能需求

### FR-1：数据库连接管理

**描述：** 用户必须能够通过提供连接 URL 来添加和管理数据库连接。系统必须存储连接信息以供将来重用。

**验收标准：**
- [ ] 用户可以输入数据库连接 URL
- [ ] 系统验证连接 URL 格式
- [ ] 系统建立与数据库的连接
- [ ] 连接信息被持久化以供将来使用
- [ ] 用户可以查看之前保存的连接列表
- [ ] 用户可以选择已保存的连接进行重用
- [ ] 连接失败时系统提供清晰的错误消息

### FR-2：架构元数据检索与显示

**描述：** 系统必须检索并显示数据库架构信息，包括连接数据库中所有可用的表和视图。

**验收标准：**
- [ ] 系统从连接的数据库中检索完整的表列表
- [ ] 系统从连接的数据库中检索完整的视图列表
- [ ] 表和视图以清晰、有序的方式显示
- [ ] 架构元数据被存储以供重用，无需重新连接
- [ ] 架构信息至少包括表/视图名称
- [ ] 系统优雅地处理没有表或视图的数据库

### FR-3：直接 SQL 查询执行

**描述：** 用户必须能够直接输入 SQL 查询并在连接的数据库上执行。

**验收标准：**
- [ ] 用户可以在查询编辑器中输入 SQL 查询
- [ ] 系统在执行前验证 SQL 语法
- [ ] 系统仅允许 SELECT 语句
- [ ] 系统拒绝非 SELECT 语句，并提供清晰的错误消息
- [ ] 系统自动为没有 LIMIT 子句的查询添加 LIMIT 1000
- [ ] 系统执行有效查询并返回结果
- [ ] 查询结果以表格格式显示
- [ ] 系统为无效的 SQL 语法提供清晰的错误消息

### FR-4：自然语言到 SQL 查询生成

**描述：** 用户必须能够通过提供查询意图的自然语言描述来生成 SQL 查询。

**验收标准：**
- [ ] 用户可以输入自然语言查询请求
- [ ] 系统使用可用的架构信息（表、视图）作为上下文
- [ ] 系统从自然语言输入生成有效的 SQL 查询
- [ ] 生成的 SQL 查询遵循与直接 SQL 输入相同的验证规则
- [ ] 用户可以在执行前查看生成的 SQL（可选）
- [ ] 系统以适当的反馈处理模糊或不明确的自然语言请求

### FR-5：查询结果显示

**描述：** 查询结果必须以清晰、可读的格式呈现给用户。

**验收标准：**
- [ ] 查询结果以结构化格式返回
- [ ] 结果以表格视图显示
- [ ] 列标题清晰标注
- [ ] 大型结果集得到适当处理（分页或滚动）
- [ ] 空结果集得到明确指示
- [ ] 结果显示具有响应性且可用

## 成功标准

- 用户在提供连接 URL 后 30 秒内成功连接到数据库并查看架构信息
- 95% 的有效 SQL 查询成功执行并返回结果
- 90% 的自然语言查询在常见查询模式下生成语法正确的 SQL
- 查询结果正确显示最多 1000 行的结果集
- 用户可以重用已保存的数据库连接，无需重新输入连接详细信息
- 系统为 100% 的失败场景提供清晰、可操作的错误消息

## 关键实体

**数据库连接：**
- 连接 URL/字符串
- 连接元数据（名称、类型等）
- 最后连接的时间戳

**架构元数据：**
- 表名称和属性
- 视图名称和属性
- 与数据库连接的关系

**查询：**
- SQL 语句文本
- 查询类型（直接 SQL 或自然语言生成）
- 关联的数据库连接
- 执行时间戳

**查询结果：**
- 结果数据行
- 列信息
- 行数
- 执行状态

## 假设

- 数据库连接使用标准连接 URL 格式
- 用户具有从表和视图读取的适当权限（SELECT 权限）
- 自然语言处理能力可用于查询生成
- SQL 解析能力可用于语法验证
- 可以使用标准数据库信息架构查询检索数据库架构元数据
- 初始实现专注于 PostgreSQL 兼容数据库，架构检索模式基于 PostgreSQL 信息架构
- 连接信息和元数据存储使用本地数据库系统
- 用户在使用直接 SQL 输入时了解基本 SQL 概念
- 自然语言查询与用户界面使用相同的语言

## 依赖项

- 用于建立连接的数据库连接库
- 用于语法验证的 SQL 解析能力
- 用于查询生成的自然语言处理
- 架构元数据检索机制
- 用于持久化连接和元数据信息的本地存储系统

## 范围外

- 数据库写入操作（INSERT、UPDATE、DELETE、CREATE、DROP 等）
- 数据库管理功能（用户管理、权限等）
- 查询优化或性能调优
- 查询历史或保存的查询功能
- 将查询结果导出到文件
- 多数据库查询执行（跨数据库连接）
- 实时数据库架构变更检测
- 数据库连接池或高级连接管理
- 查询结果缓存
- 协作功能（共享查询或连接）

## 备注

- 系统优先考虑只读操作以确保安全性和简单性
- 架构元数据缓存提高了重复查询的性能
- 自动添加 LIMIT 可防止意外检索大型结果集
- 自然语言查询生成依赖于准确的架构信息，因此架构元数据的质量至关重要
- 未来的增强可能包括支持除初始 PostgreSQL 重点实现之外的其他数据库类型

